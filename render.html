<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>graphics</title>
</head>
<link rel="stylesheet" href="render.css">
<div>
    <button id="loadForest"> load forest </button>
    <button id="loadCube"> load cube </button>
</div>
<body>
    <canvas id="myCanvas" repetition="no-repeat"></canvas>
    <script src="WASM_forestDemo.js"></script>
    <script src="globalFuncs.js"></script>
    <script>
        var wcPtr, ctx, imageData;
        var initialize, renderPass, getFrameBuffer, initializeFromObj, deleteWebContext;
        var keyStates = {};
        var rx = 0.0, ry = 0.0, rz = 0.0;
        const canvas = document.getElementById('myCanvas');
        canvas.width = 800;
        canvas.height = 600;

        Module.onRuntimeInitialized = () => { 
            
            initialize = Module._initialize;
            initializeFromObj = Module._initializeFromObj;
            renderPass = Module._renderPass; 
            getFrameBuffer = Module._getFrameBuffer;
            deleteWebContext = Module._deleteWebContext;

            wcPtr = initializeFromObj(canvas.width, canvas.height);
            const pixelDataPtr = getFrameBuffer(wcPtr);
            const pixelData = new Uint8ClampedArray(Module.HEAPU8.buffer, pixelDataPtr, canvas.width * canvas.height * 4);
            ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            renderPass(wcPtr, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0);
            imageData = new ImageData(pixelData, canvas.width, canvas.height);
            for(i = 0; i < pixelData.length; i++){
                if(pixelData[i] != 0 && pixelData[i] != 255) {
                    console.log(pixelData[i]);
                }
            }
            ctx.putImageData(imageData, 0, 0);
        };

        window.addEventListener('keydown', (event) => {
            keyStates[event.code] = true;
            if (event.code === 'ShiftLeft') {
                event.preventDefault();
            }
            transform();
        });

        window.addEventListener('keyup', (event) => {
            keyStates[event.code] = false;
        });

        document.getElementById('loadForest').addEventListener('click', function() {
            deleteWebContext(wcPtr);
            wcPtr = initializeFromObj(canvas.width, canvas.height);
            renderPass(wcPtr, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0);
        });

    </script>
</body>
</html>